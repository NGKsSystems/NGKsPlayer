<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGKsPlayer - Library Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 0.9em;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #0c5460;
            font-size: 0.9em;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .steps {
            list-style: none;
            counter-reset: step-counter;
            margin-left: 0;
        }

        .steps li {
            counter-increment: step-counter;
            margin-bottom: 12px;
            padding-left: 35px;
            position: relative;
            color: #555;
            font-size: 0.95em;
        }

        .steps li:before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
        }

        .music-folder {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #333;
            word-break: break-all;
            margin-top: 8px;
        }

        .file-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Library Manager</h1>
        <p class="subtitle">NGKsPlayer Library Management Tool</p>

        <div class="section">
            <h2>‚ö†Ô∏è Current Status</h2>
            <div id="status-info" class="info" style="display: none;"></div>
            <p id="library-info">Click "Check Library" to see current status...</p>
        </div>

        <div class="section">
            <h2>üßπ Clean Library</h2>
            <p>Your library currently contains STEM separations and other unwanted files that have been moved out of your Music folder. Clear and rebuild your library to include only valid audio files from your Music folder.</p>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Warning:</strong> This action will delete all playlists and playback history! You cannot undo this operation.
            </div>

            <div class="info">
                <strong>‚ÑπÔ∏è What happens:</strong>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>All tracks, playlists, and history are cleared</li>
                    <li>Your Music folder is rescanned for valid audio files</li>
                    <li>Analysis data (BPM, Key, etc.) will be lost - you'll need to re-analyze</li>
                </ul>
            </div>

            <div class="buttons">
                <button class="btn-primary" id="check-btn" onclick="checkLibrary()">üìä Check Library</button>
                <button class="btn-danger" id="clear-btn" onclick="clearLibrary()" disabled>üóëÔ∏è Clear & Rebuild</button>
                <button class="btn-secondary" id="cancel-btn" onclick="resetUI()" style="display: none;">‚úñÔ∏è Cancel</button>
            </div>
        </div>

        <div class="section">
            <h2>üìù What You Need to Do</h2>
            <ol class="steps">
                <li>Click "Check Library" to verify current status</li>
                <li>If you see stem separations or unwanted files, click "Clear & Rebuild"</li>
                <li>Wait for the operation to complete (this may take a moment)</li>
                <li>Close and restart NGKsPlayer</li>
                <li>Your library will now contain only music from your Music folder</li>
            </ol>
        </div>

        <div class="music-folder">
            <strong>Music Folder:</strong><br>
            C:\Users\<span id="username">suppo</span>\Music
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        // Try to get username from electron API if available
        if (window.api && window.api.invoke) {
            // We're in Electron
            console.log('Running in Electron environment');
        } else {
            console.log('Not running in Electron - this is a demo interface');
        }

        async function checkLibrary() {
            const btn = document.getElementById('check-btn');
            const statusDiv = document.getElementById('status');
            const statusInfo = document.getElementById('status-info');
            const libraryInfo = document.getElementById('library-info');
            
            btn.disabled = true;
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '<span class="spinner"></span>Checking library...';

            try {
                if (window.api && window.api.invoke) {
                    // Get track count
                    const result = await window.api.invoke('db:getTrackCount');
                    
                    libraryInfo.innerHTML = `<strong>Current Library:</strong> ${result.count} tracks`;
                    
                    if (result.count > 0) {
                        statusInfo.style.display = 'block';
                        statusInfo.innerHTML = `<strong>‚ö†Ô∏è Your library has ${result.count} entries.</strong><br>This likely includes the STEM separations that have been moved out of your Music folder. You should clear and rebuild to remove them.`;
                        
                        document.getElementById('clear-btn').disabled = false;
                        statusDiv.className = 'status success';
                        statusDiv.innerHTML = '‚úì Library checked successfully. Ready to clear if needed.';
                    } else {
                        statusDiv.className = 'status info';
                        statusDiv.innerHTML = '‚úì Your library is already empty.';
                        document.getElementById('clear-btn').disabled = true;
                    }
                } else {
                    throw new Error('API not available - this tool must be run from within the NGKsPlayer application');
                }
            } catch (err) {
                console.error('Error:', err);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<strong>Error:</strong> ${err.message || 'Could not check library'}`;
                document.getElementById('clear-btn').disabled = true;
            } finally {
                btn.disabled = false;
            }
        }

        async function clearLibrary() {
            const confirmed = window.confirm(
                '‚ö†Ô∏è FINAL WARNING!\n\n' +
                'This will PERMANENTLY DELETE:\n' +
                '‚Ä¢ All tracks from your library\n' +
                '‚Ä¢ All playlists\n' +
                '‚Ä¢ All playback history\n' +
                '‚Ä¢ All analysis data (BPM, Key, etc.)\n\n' +
                'This CANNOT be undone!\n\n' +
                'Your Music folder will be rescanned to rebuild the library.\n\n' +
                'Are you absolutely sure?'
            );

            if (!confirmed) return;

            const clearBtn = document.getElementById('clear-btn');
            const checkBtn = document.getElementById('check-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const statusDiv = document.getElementById('status');

            clearBtn.disabled = true;
            checkBtn.disabled = true;
            cancelBtn.style.display = 'inline-block';

            statusDiv.className = 'status info';
            statusDiv.innerHTML = '<span class="spinner"></span>Clearing library and rescanning Music folder...';

            try {
                if (!window.api || !window.api.invoke) {
                    throw new Error('API not available');
                }

                // Get Music folder path
                const musicPath = `C:\\Users\\${(window.location.pathname.split('/').pop() || 'user')}\\Music`;
                
                const result = await window.api.invoke('db:clearAndRebuild', [musicPath]);

                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `<strong>‚úì Success!</strong><br><br>${result.message}<br><br><strong>Next step:</strong> Close and restart NGKsPlayer to complete the process.`;
                    
                    document.getElementById('library-info').innerHTML = `<strong>Updated Library:</strong> ${result.totalAdded} tracks added from your Music folder`;
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (err) {
                console.error('Error:', err);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<strong>Error:</strong> ${err.message || 'Failed to clear library'}`;
                clearBtn.disabled = false;
                checkBtn.disabled = false;
            } finally {
                cancelBtn.style.display = 'inline-block';
            }
        }

        function resetUI() {
            document.getElementById('status').className = 'status';
            document.getElementById('status').innerHTML = '';
            document.getElementById('check-btn').disabled = false;
            document.getElementById('clear-btn').disabled = true;
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // Load username if in Electron
        if (window.api && window.api.invoke) {
            window.api.invoke('sys:getUsername').catch(() => {
                // Fallback to default
            });
        }
    </script>
</body>
</html>
